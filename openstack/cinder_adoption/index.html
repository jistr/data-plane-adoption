
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="OpenStack Data Plane Adoption">
      
      
        <meta name="author" content="OpenStack Team">
      
      
        <link rel="canonical" href="https://openstack-k8s-operators.github.io/data-plane-adoption/openstack/cinder_adoption/">
      
      
        <link rel="prev" href="../placement_adoption/">
      
      
        <link rel="next" href="../horizon_adoption/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>Cinder adoption - OpenStack Data Plane Adoption</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cinder-adoption" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OpenStack Data Plane Adoption" class="md-header__button md-logo" aria-label="OpenStack Data Plane Adoption" data-md-component="logo">
      
  <img src="../../images/openstack-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OpenStack Data Plane Adoption
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cinder adoption
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/openstack-k8s-operators/data-plane-adoption" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    openstack-k8s-operators/data-plane-adoption
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OpenStack Data Plane Adoption" class="md-nav__button md-logo" aria-label="OpenStack Data Plane Adoption" data-md-component="logo">
      
  <img src="../../images/openstack-logo.png" alt="logo">

    </a>
    OpenStack Data Plane Adoption
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openstack-k8s-operators/data-plane-adoption" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    openstack-k8s-operators/data-plane-adoption
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    OpenStack
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            OpenStack
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../planning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Planning the new deployment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend_services_deployment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backend services deployment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pull_openstack_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pull Openstack configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stop_openstack_services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stop OpenStack services
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mariadb_copy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MariaDB data copy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ovn_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OVN data migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../keystone_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Keystone adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../neutron_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neutron adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ceph_backend_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ceph backend configuration (if applicable)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../glance_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Glance adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../placement_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Placement adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cinder adoption
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cinder adoption
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Limitations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    <span class="md-ellipsis">
      Variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Pre-checks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-openshift" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare OpenShift
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare OpenShift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Node Selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transport-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      Transport protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transport protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nfs" class="md-nav__link">
    <span class="md-ellipsis">
      NFS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rbdceph" class="md-nav__link">
    <span class="md-ellipsis">
      RBD/Ceph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iscsi" class="md-nav__link">
    <span class="md-ellipsis">
      iSCSI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fc" class="md-nav__link">
    <span class="md-ellipsis">
      FC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nvme-of" class="md-nav__link">
    <span class="md-ellipsis">
      NVMe-oF
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multipathing" class="md-nav__link">
    <span class="md-ellipsis">
      Multipathing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Configurations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-the-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare the configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare the configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-generation-helper-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration generation helper tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#procedure-cinder-adoption" class="md-nav__link">
    <span class="md-ellipsis">
      Procedure - Cinder adoption
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Post-checks
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../horizon_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Horizon adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../edpm_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EDPM adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ironic_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ironic adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heat_adoption/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Heat adoption
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ceph
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Ceph
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ceph/ceph_rbd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ceph RBD migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ceph/ceph_rgw/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ceph RGW migration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/documentation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing to documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/development_environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/tests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tests
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Limitations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variables" class="md-nav__link">
    <span class="md-ellipsis">
      Variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Pre-checks
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-openshift" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare OpenShift
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare OpenShift">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Node Selection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#transport-protocols" class="md-nav__link">
    <span class="md-ellipsis">
      Transport protocols
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transport protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nfs" class="md-nav__link">
    <span class="md-ellipsis">
      NFS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rbdceph" class="md-nav__link">
    <span class="md-ellipsis">
      RBD/Ceph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iscsi" class="md-nav__link">
    <span class="md-ellipsis">
      iSCSI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fc" class="md-nav__link">
    <span class="md-ellipsis">
      FC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nvme-of" class="md-nav__link">
    <span class="md-ellipsis">
      NVMe-oF
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multipathing" class="md-nav__link">
    <span class="md-ellipsis">
      Multipathing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurations" class="md-nav__link">
    <span class="md-ellipsis">
      Configurations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-the-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare the configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prepare the configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-generation-helper-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration generation helper tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#procedure-cinder-adoption" class="md-nav__link">
    <span class="md-ellipsis">
      Procedure - Cinder adoption
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#post-checks" class="md-nav__link">
    <span class="md-ellipsis">
      Post-checks
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="cinder-adoption">Cinder adoption<a class="headerlink" href="#cinder-adoption" title="Permanent link">#</a></h1>
<p>Adopting a director deployed Cinder service into OpenStack may require some
thought because it's not always a simple process.</p>
<p>Usually the adoption process entails:</p>
<ul>
<li>Checking existing limitations.</li>
<li>Considering the placement of the cinder services.</li>
<li>Preparing the OpenShift nodes where volume and backup services will run.</li>
<li>Crafting the manifest based on the existing <code>cinder.conf</code> file.</li>
<li>Deploying Cinder.</li>
<li>Validating the new deployment.</li>
</ul>
<p>This guide provides necessary knowledge to complete these steps in most
situations, but it still requires knowledge on how OpenStack services work and
the structure of a Cinder configuration file.</p>
<h2 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permanent link">#</a></h2>
<p>There are currently some limitations that are worth highlighting; some are
related to this guideline while some to the operator:</p>
<ul>
<li>
<p>There is no global <code>nodeSelector</code> for all cinder volumes, so it needs to be
specified per backend.  This may change in the future.</p>
</li>
<li>
<p>There is no global <code>customServiceConfig</code> or <code>customServiceConfigSecrets</code> for
all cinder volumes, so it needs to be specified per backend.  This may change in
the future.</p>
</li>
<li>
<p>Adoption of LVM backends, where the volume data is stored in the compute
nodes, is not currently being documented in this process. It may get documented
in the future.</p>
</li>
<li>
<p>Support for Cinder backends that require kernel modules not included in RHEL
has not been tested in Operator deployed OpenStack so it is not documented in
this guide.</p>
</li>
<li>
<p>Adoption of DCN/Edge deployment is not currently described in this guide.</p>
</li>
</ul>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">#</a></h2>
<ul>
<li>
<p>Previous Adoption steps completed. Notably, cinder service must have been
stopped and the service databases must already be imported into the podified
MariaDB.</p>
</li>
<li>
<p>Storage network has been properly configured on the OpenShift cluster.</p>
</li>
</ul>
<h2 id="variables">Variables<a class="headerlink" href="#variables" title="Permanent link">#</a></h2>
<p>No new environmental variables need to be defined, though we use the
<code>CONTROLLER1_SSH</code> that was defined in a previous step for the pre-checks.</p>
<h2 id="pre-checks">Pre-checks<a class="headerlink" href="#pre-checks" title="Permanent link">#</a></h2>
<p>We are going to need the contents of <code>cinder.conf</code>, so we may want to download
it to have it locally accessible:</p>
<div class="highlight"><pre><span></span><code>$CONTROLLER1_SSH cat /var/lib/config-data/puppet-generated/cinder/etc/cinder/cinder.conf &gt; cinder.conf
</code></pre></div>
<h2 id="prepare-openshift">Prepare OpenShift<a class="headerlink" href="#prepare-openshift" title="Permanent link">#</a></h2>
<p>As explained the <a href="../planning/">planning section</a> before deploying OpenStack in
OpenShift we need to ensure that the networks are ready, that we have decided
the node selection, and also make sure any necessary changes to the OpenShift
nodes have been made.  For Cinder volume and backup services all these 3 must
be carefully considered.</p>
<h3 id="node-selection">Node Selection<a class="headerlink" href="#node-selection" title="Permanent link">#</a></h3>
<p>We may need, or want, to restrict the OpenShift nodes where cinder volume and
backup services can run.</p>
<p>The best example of when we need to do node selection for a specific cinder
service in when we deploy Cinder with the LVM driver. In that scenario the
LVM data where the volumes are stored only exists in a specific host, so we
need to pin the cinder-volume service to that specific OpenShift node.  Running
the service on any other OpenShift node would not work.  Since <code>nodeSelector</code>
only works on labels we cannot use the OpenShift host node name to restrict
the LVM backend and we'll need to identify it using a unique label, an existing
or new one:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>oc<span class="w"> </span>label<span class="w"> </span>nodes<span class="w"> </span>worker0<span class="w"> </span><span class="nv">lvm</span><span class="o">=</span>cinder-volumes
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core.openstack.org/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OpenStackControlPlane</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osp-secret</span>
<span class="w">  </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local-storage</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cinderVolumes</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lvm-iscsi</span><span class="p">:</span>
<span class="w">          </span><span class="nt">nodeSelector</span><span class="p">:</span>
<span class="w">            </span><span class="nt">lvm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder-volumes</span>
<span class="l l-Scalar l-Scalar-Plain">&lt; . . . &gt;</span>
</code></pre></div>
<p>As mentioned in the <a href="../node-selector/">Node Selector guide</a>, an example where we
need to use labels is when using FC storage and we don't have HBA cards in all
our OpenShift nodes. In this scenario we would need to restrict all the cinder
volume backends (not only the FC one) as well as the backup services.</p>
<p>Depending on the cinder backends, their configuration, and the usage of Cinder,
we can have network intensive cinder volume services with lots of I/O as well as
cinder backup services that are not only network intensive but also memory and
CPU intensive.  This may be a concern for the OpenShift human operators, and
they may want to use the <code>nodeSelector</code> to prevent these service from
interfering with their other OpenShift workloads</p>
<p>Please make sure to read the <a href="node-selector">Nodes Selector guide</a> before
continuing, as we'll be referring to some of the concepts explained there in the
following sections.</p>
<p>When selecting the nodes where cinder volume is going to run please remember
that cinder-volume may also use local storage when downloading a glance image
for the create volume from image operation, and it can require a considerable
amount of space when having concurrent operations and not using cinder volume
cache.</p>
<p>If we don't have nodes with enough local disk space for the temporary images we
can use a remote NFS location for the images. This is something that we had to
manually setup in Director deployments, but with operators we can easily do it
automatically using the extra volumes feature ()<code>extraMounts</code>.</p>
<h3 id="transport-protocols">Transport protocols<a class="headerlink" href="#transport-protocols" title="Permanent link">#</a></h3>
<p>Due to the specifics of the storage transport protocols some changes may be
required on the OpenShift side, and although this is something that must be
documented by the Vendor here wer are going to provide some generic
instructions that can serve as a guide for the different transport protocols.</p>
<p>Check the backend sections in our <code>cinder.conf</code> file that are listed in the
<code>enabled_backends</code> configuration option to figure out the transport storage
protocol used by the backend.</p>
<p>Depending on the backend we can find the transport protocol:</p>
<ul>
<li>
<p>Looking at the <code>volume_driver</code> configuration option, as it may contain the
  protocol itself: RBD, iSCSI, FC...</p>
</li>
<li>
<p>Looking at the <code>target_protocol</code> configuration option</p>
</li>
</ul>
<p><em>Warning:</em> Any time a <code>MachineConfig</code> is used to make changes to OpenShift
nodes the node will reboot!!  Act accordingly.</p>
<h4 id="nfs">NFS<a class="headerlink" href="#nfs" title="Permanent link">#</a></h4>
<p>There's nothing to do for NFS. OpenShift can connect to NFS backends without
any additional changes.</p>
<h4 id="rbdceph">RBD/Ceph<a class="headerlink" href="#rbdceph" title="Permanent link">#</a></h4>
<p>There's nothing to do for RBD/Ceph in terms of preparing the nodes, OpenShift
can connect to Ceph backends without any additional changes. Credentials and
configuration files will need to be provided to the services though.</p>
<h4 id="iscsi">iSCSI<a class="headerlink" href="#iscsi" title="Permanent link">#</a></h4>
<p>Connecting to iSCSI volumes requires that the iSCSI initiator is running on the
OpenShift hosts hosts where volume and backup services are going to run, because
the Linux Open iSCSI initiator doesn't currently support network namespaces, so
we must only run 1 instance of the service for the normal OpenShift usage, plus
the OpenShift CSI plugins, plus the OpenStack services.</p>
<p>If we are not already running <code>iscsid</code> on the OpenShift nodes then we'll need
to apply a <code>MachineConfig</code> similar to this one:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">machineconfiguration.openshift.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MachineConfig</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">machineconfiguration.openshift.io/role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">99-master-cinder-enable-iscsid</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ignition</span><span class="p">:</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.2.0</span>
<span class="w">    </span><span class="nt">systemd</span><span class="p">:</span>
<span class="w">      </span><span class="nt">units</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iscsid.service</span>
</code></pre></div>
<p>Remember that if we are using labels to restrict the nodes where cinder
services are running we'll need to use a <code>MachineConfigPool</code> as described in
the <a href="node-labels">nodes selector guide</a> to limit the effects of the
<code>MachineConfig</code> to only the nodes were our services may run.</p>
<p>If we are using a toy single node deployment to test the process we may need to
replace <code>worker</code> with <code>master</code> in the <code>MachineConfig</code>.</p>
<p>For production deployments using iSCSI volumes we always recommend setting up
multipathing, please look at the <a href="#multipathing">multipathing section</a> to see
how to configure it.</p>
<p><strong>TODO:</strong> Add, or at least mention, the Nova eDPM side for iSCSI.</p>
<h4 id="fc">FC<a class="headerlink" href="#fc" title="Permanent link">#</a></h4>
<p>There's nothing to do for FC volumes to work, but the <em>cinder volume and cinder
backup services need to run in an OpenShift host that has HBAs</em>, so if there
are nodes that don't have HBAs then we'll need to use labels to restrict where
these services can run, as mentioned in the <a href="#node-labels">node labels section</a>.</p>
<p>This also means that for virtualized OpenShift clusters using FC we'll need to
expose the host's HBAs inside the VM.</p>
<p>For production deployments using FC volumes we always recommend setting up
multipathing, please look at the <a href="#multipathing">multipathing section</a> to see
how to configure it.</p>
<h4 id="nvme-of">NVMe-oF<a class="headerlink" href="#nvme-of" title="Permanent link">#</a></h4>
<p>Connecting to NVMe-oF volumes requires that the nvme kernel modules are loaded
on the OpenShift hosts.</p>
<p>If we are not already loading the <code>nvme-fabrics</code> module on the OpenShift nodes
where volume and backup services are going to run then we'll need to apply a
<code>MachineConfig</code> similar to this one:</p>
<div class="highlight"><pre><span></span><code>apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
    service: cinder
  name: 99-master-cinder-load-nvme-fabrics
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - path: /etc/modules-load.d/nvme_fabrics.conf
          overwrite: false
          # Mode must be decimal, this is 0644
          mode: 420
          user:
            name: root
          group:
            name: root
          contents:
            # Source can be a http, https, tftp, s3, gs, or data as defined in rfc2397.
            # This is the rfc2397 text/plain string format
            source: data:,nvme-fabrics
</code></pre></div>
<p>Remember that if we are using labels to restrict the nodes where cinder
services are running we'll need to use a <code>MachineConfigPool</code> as described in
the <a href="node-labels">nodes selector guide</a> to limit the effects of the
<code>MachineConfig</code> to only the nodes were our services may run.</p>
<p>If we are using a toy single node deployment to test the process we may need to
replace <code>worker</code> with <code>master</code> in the <code>MachineConfig</code>.</p>
<p>We are only loading the <code>nvme-fabrics</code> module because it takes care of loading
the transport specific modules (tcp, rdma, fc) as needed.</p>
<p>For production deployments using NVMe-oF volumes we always recommend using
multipathing. For NVMe-oF volumes OpenStack uses native multipathing, called
<a href="https://nvmexpress.org/faq-items/what-is-ana-nvme-multipathing/">ANA</a>.</p>
<p>Once the OpenShift nodes have rebooted and are loading the <code>nvme-fabrics</code> module
we can confirm that the Operating System is configured and supports ANA by
checking on the host:</p>
<div class="highlight"><pre><span></span><code>cat /sys/module/nvme_core/parameters/multipath
</code></pre></div>
<p><strong>Attention:</strong> ANA doesn't use the Linux Multipathing Device Mapper, but the
*current OpenStack
code requires <code>multipathd</code> on compute nodes to be running for Nova to be able to
use multipathing, so please remember to follow the multipathing part for compute
nodes on the <a href="#multipathing">multipathing section</a>.</p>
<p><strong>TODO:</strong> Add, or at least mention, the Nova eDPM side for NVMe-oF.</p>
<h4 id="multipathing">Multipathing<a class="headerlink" href="#multipathing" title="Permanent link">#</a></h4>
<p>For iSCSI and FC protocols we always recommend using multipathing, which
has 4 parts:</p>
<ul>
<li>Prepare the OpenShift hosts</li>
<li>Configure the Cinder services</li>
<li>Prepare the Nova computes</li>
<li>Configure the Nova service</li>
</ul>
<p>To prepare the OpenShift hosts we need to ensure that the Linux Multipath
Device Mapper is configured and running on the OpenShift hosts, and we do
that using <code>MachineConfig</code> like this one:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Includes the /etc/multipathd.conf contents and the systemd unit changes</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">machineconfiguration.openshift.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MachineConfig</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">machineconfiguration.openshift.io/role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">worker</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">99-master-cinder-enable-multipathd</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ignition</span><span class="p">:</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.2.0</span>
<span class="w">    </span><span class="nt">storage</span><span class="p">:</span>
<span class="w">      </span><span class="nt">files</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/multipath.conf</span>
<span class="w">          </span><span class="nt">overwrite</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">          </span><span class="c1"># Mode must be decimal, this is 0600</span>
<span class="w">          </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">384</span>
<span class="w">          </span><span class="nt">user</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">          </span><span class="nt">group</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">          </span><span class="nt">contents</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Source can be a http, https, tftp, s3, gs, or data as defined in rfc2397.</span>
<span class="w">            </span><span class="c1"># This is the rfc2397 text/plain string format</span>
<span class="w">            </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data:,defaults%20%7B%0A%20%20user_friendly_names%20no%0A%20%20recheck_wwid%20yes%0A%20%20skip_kpartx%20yes%0A%20%20find_multipaths%20yes%0A%7D%0A%0Ablacklist%20%7B%0A%7D</span>
<span class="w">    </span><span class="nt">systemd</span><span class="p">:</span>
<span class="w">      </span><span class="nt">units</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">multipathd.service</span>
</code></pre></div>
<p>Remember that if we are using labels to restrict the nodes where cinder
services are running we'll need to use a <code>MachineConfigPool</code> as described in
the <a href="node-labels">nodes selector guide</a> to limit the effects of the
<code>MachineConfig</code> to only the nodes were our services may run.</p>
<p>If we are using a toy single node deployment to test the process we may need to
replace <code>worker</code> with <code>master</code> in the <code>MachineConfig</code>.</p>
<p>To configure the cinder services to use multipathing we need to enable the
<code>use_multipath_for_image_xfer</code> configuration option in all the backend sections
and in the <code>[DEFAULT]</code> section for the backup service, but in Podified
deployments we don't need to worry about it, because that's the default. So as
long as we don't override it setting <code>use_multipath_for_image_xfer = false</code> then
multipathing will work as long as the service is running on the OpenShift host.</p>
<p><strong>TODO:</strong> Add, or at least mention, the Nova eDPM side for Multipathing once
it's implemented.</p>
<h2 id="configurations">Configurations<a class="headerlink" href="#configurations" title="Permanent link">#</a></h2>
<p>As described in the <a href="../planning/">planning</a> Cinder is configured using
configuration snippets instead of using obscure configuration parameters
defined by the installer.</p>
<p>The recommended way to deploy Cinder volume backends has changed to remove old
limitations, add flexibility, and improve operations in general.</p>
<p>When deploying with Director we used to run a single Cinder volume service with
all our backends (each backend would run on its own process), and even though
that way of deploying is still supported, we don't recommend it. We recommend
using a volume service per backend since it's a superior deployment model.</p>
<p>So for an LVM and a Ceph backend we would have 2 entries in <code>cinderVolume</code> and,
as mentioned in the limitations section, we cannot set global defaults for all
volume services, so we would have to define it for each of them, like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core.openstack.org/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OpenStackControlPlane</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cinderVolume</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lvm</span><span class="p">:</span>
<span class="w">          </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">[DEFAULT]</span>
<span class="w">            </span><span class="no">debug = True</span>
<span class="w">            </span><span class="no">[lvm]</span>
<span class="l l-Scalar l-Scalar-Plain">&lt; . . . &gt;</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">ceph</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">[DEFAULT]</span>
<span class="w">            </span><span class="no">debug = True</span>
<span class="w">            </span><span class="no">[ceph]</span>
<span class="l l-Scalar l-Scalar-Plain">&lt; . . . &gt;</span>
</code></pre></div>
<p>Reminder that for volume backends that have sensitive information using <code>Secret</code>
and the <code>customServiceConfigSecrets</code> key is the recommended way to go.</p>
<h2 id="prepare-the-configuration">Prepare the configuration<a class="headerlink" href="#prepare-the-configuration" title="Permanent link">#</a></h2>
<p>For adoption instead of using a whole deployment manifest we'll use a targeted
patch, like we did with other services, and in this patch we will enable the
different cinder services with their specific configurations.</p>
<p><strong>WARNING:</strong> Check that all configuration options are still valid for the new
OpenStack version, since configuration options may have been deprecated,
removed, or added. This applies to both backend driver specific configuration
options and other generic options.</p>
<p>There are 2 ways to prepare a cinder configuration for adoption, tailor-making
it or doing it quick and dirty. There is no difference in how Cinder will
operate with both methods, so we are free to chose, though we recommend
tailor-making it whenever possible.</p>
<p>The high level explanation of the tailor-made approach is:</p>
<ol>
<li>
<p>Determine what part of the configuration is generic for all the cinder
services and remove anything that would change when deployed in OpenShift, like
the <code>connection</code> in the <code>[dabase]</code> section, the <code>transport_url</code> and <code>log_dir</code> in
<code>[DEFAULT]</code>, the whole <code>[coordination]</code> section.  This configuration goes into
the <code>customServiceConfig</code> (or a <code>Secret</code> and then used in
<code>customServiceConfigSecrets</code>) at the <code>cinder: template:</code> level.</p>
</li>
<li>
<p>Determine if there's any scheduler specific configuration and add it to the
<code>customServiceConfig</code> section in <code>cinder: template: cinderScheduler</code>.</p>
</li>
<li>
<p>Determine if there's any API specific configuration and add it to the
<code>customServiceConfig</code> section in <code>cinder: template: cinderAPI</code>.</p>
</li>
<li>
<p>If we have cinder backup deployed, then we'll get the cinder backup relevant
configuration options and add them to <code>customServiceConfig</code> (or a <code>Secret</code> and
then used in <code>customServiceConfigSecrets</code>) at the <code>cinder: template:
cinderBackup:</code> level. We should remove the <code>host</code> configuration in the
<code>[DEFAULT]</code> section to facilitate supporting multiple replicas in the future.</p>
</li>
<li>
<p>Determine the individual volume backend configuration for each of the
drivers. The configuration will not only be the specific driver section, it
should also include the <code>[backend_defaults]</code> section and FC zoning sections is
they are being used, because the cinder operator doesn't support a
<code>customServiceConfig</code> section global for all volume services.  Each backend
would have its own section under <code>cinder: template: cinderVolumes</code> and the
configuration would go in <code>customServiceConfig</code> (or a <code>Secret</code> and then used in
<code>customServiceConfigSecrets</code>).</p>
</li>
<li>
<p>Check if any of the cinder volume drivers being used requires a custom vendor
image. If they do, find the location of the image in the vendor's instruction
available in the w <a href="https://catalog.redhat.com/software/search?target_platforms=Red%20Hat%20OpenStack%20Platform&amp;p=1&amp;functionalCategories=Data%20storage">OpenStack Cinder ecosystem
page</a>
and add it under the specific's driver section using the <code>containerImage</code> key.
For example, if we had a Pure Storage array and the driver was already certified
for OSP18, then we would have something like this:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cinderVolume</span><span class="p">:</span>
<span class="w">        </span><span class="nt">pure</span><span class="p">:</span>
<span class="w">          </span><span class="nt">containerImage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.connect.redhat.com/purestorage/openstack-cinder-volume-pure-rhosp-18-0&#39;</span>
<span class="w">          </span><span class="nt">customServiceConfigSecrets</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack-cinder-pure-cfg</span>
<span class="l l-Scalar l-Scalar-Plain">&lt; . . . &gt;</span>
</code></pre></div>
<ol>
<li>External files: Cinder services sometimes use external files, for example for
a custom policy, or to store credentials, or SSL CA bundles to connect to a
storage array, and we need to make those files available to the right
containers. To achieve this we'll use <code>Secrets</code> or <code>ConfigMap</code> to store the
information in OpenShift and then the <code>extraMounts</code> key. For example, for the
Ceph credentials stored in a <code>Secret</code> called <code>ceph-conf-files</code> we would patch
the top level <code>extraMounts</code> in <code>OpenstackControlPlane</code>:</li>
</ol>
<p><div class="highlight"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extraMounts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">extraVol</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">extraVolType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ceph</span>
<span class="w">      </span><span class="nt">mounts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ceph</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
<span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">propagation</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CinderVolume</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CinderBackup</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Glance</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
<span class="w">        </span><span class="nt">projected</span><span class="p">:</span>
<span class="w">          </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph-conf-files</span>
</code></pre></div>
   But for a service specific one, like the API policy, we would do it directly
   on the service itself, in this example we include the cinder API
   configuration that references the policy we are adding from a <code>ConfigMap</code>
   called <code>my-cinder-conf</code> that has a key <code>policy</code> with the contents of the
   policy:
   <div class="highlight"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cinderAPI</span><span class="p">:</span>
<span class="w">        </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">           </span><span class="no">[oslo_policy]</span>
<span class="w">           </span><span class="no">policy_file=/etc/cinder/api/policy.yaml</span>
<span class="w">      </span><span class="nt">extraMounts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">extraVol</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">extraVolType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ceph</span>
<span class="w">          </span><span class="nt">mounts</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/cinder/api</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy</span>
<span class="w">            </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">          </span><span class="nt">propagation</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CinderAPI</span>
<span class="w">          </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy</span>
<span class="w">            </span><span class="nt">projected</span><span class="p">:</span>
<span class="w">              </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">              </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMap</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-cinder-conf</span>
<span class="w">                  </span><span class="nt">items</span><span class="p">:</span>
<span class="w">                    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy</span>
<span class="w">                      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy.yaml</span>
</code></pre></div></p>
<p>The quick and dirty process is more straightforward:</p>
<ol>
<li>
<p>Create an agnostic configuration file removing any specifics from the old
deployment's <code>cinder.conf</code> file, like the <code>connection</code> in the <code>[dabase]</code>
section, the <code>transport_url</code> and <code>log_dir</code> in <code>[DEFAULT]</code>, the whole
<code>[coordination]</code> section, etc..</p>
</li>
<li>
<p>Assuming the configuration has sensitive information, drop the modified
contents of the whole file into a <code>Secret</code>.</p>
</li>
<li>
<p>Reference this secret in all the services, creating a cinder volumes section
for each backend and just adding the respective <code>enabled_backends</code> option.</p>
</li>
<li>
<p>Add external files as mentioned in the last bullet of the tailor-made
configuration explanation.</p>
</li>
</ol>
<p>Example of what the quick and dirty configuration patch would look like:</p>
<div class="highlight"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cinderAPI</span><span class="p">:</span>
<span class="w">        </span><span class="nt">customServiceConfigSecrets</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder-conf</span>
<span class="w">      </span><span class="nt">cinderScheduler</span><span class="p">:</span>
<span class="w">        </span><span class="nt">customServiceConfigSecrets</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder-conf</span>
<span class="w">      </span><span class="nt">cinderBackup</span><span class="p">:</span>
<span class="w">        </span><span class="nt">customServiceConfigSecrets</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder-conf</span>
<span class="w">      </span><span class="nt">cinderVolume</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lvm1</span><span class="p">:</span>
<span class="w">          </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">[DEFAULT]</span>
<span class="w">            </span><span class="no">enabled_backends = lvm1</span>
<span class="w">          </span><span class="nt">customServiceConfigSecrets</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder-conf</span>
<span class="w">        </span><span class="nt">lvm2</span><span class="p">:</span>
<span class="w">          </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">[DEFAULT]</span>
<span class="w">            </span><span class="no">enabled_backends = lvm2</span>
<span class="w">          </span><span class="nt">customServiceConfigSecrets</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cinder-conf</span>
</code></pre></div>
<h3 id="configuration-generation-helper-tool">Configuration generation helper tool<a class="headerlink" href="#configuration-generation-helper-tool" title="Permanent link">#</a></h3>
<p>Creating the right Cinder configuration files to deploy using Operators may
sometimes be a complicated experience, especially the first times, so we have a
helper tool that can create a draft of the files from a <code>cinder.conf</code> file.</p>
<p>This tool is not meant to be a automation tool, it's mostly to help us get the
gist of it, maybe point out some potential pitfalls and reminders.</p>
<p><strong>Attention:</strong> The tools requires <code>PyYAML</code> Python package to be installed (<code>pip
install PyYAML</code>).</p>
<p>This <a href="../helpers/cinder-cfg.py">cinder-cfg.py script</a> defaults to reading the
<code>cinder.conf</code> file from the current directory (unless <code>--config</code> option is used)
and outputs files to the current directory (unless <code>--out-dir</code> option is used).</p>
<p>In the output directory we'll always get a <code>cinder.patch</code> file with the Cinder
specific configuration patch to apply to the <code>OpenStackControlPlane</code> CR but we
may also get an additional file called <code>cinder-prereq.yaml</code> file with some
<code>Secrets</code> and <code>MachineConfigs</code>.</p>
<p>Example of an invocation setting input and output explicitly to the defaults for
a Ceph backend:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>cinder-cfg.py<span class="w"> </span>--config<span class="w"> </span>cinder.conf<span class="w"> </span>--out-dir<span class="w"> </span>./
WARNING:root:Cinder<span class="w"> </span>is<span class="w"> </span>configured<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span><span class="o">[</span><span class="s1">&#39;/etc/cinder/policy.yaml&#39;</span><span class="o">]</span><span class="w"> </span>as<span class="w"> </span>policy<span class="w"> </span>file,<span class="w"> </span>please<span class="w"> </span>ensure<span class="w"> </span>this<span class="w"> </span>file<span class="w"> </span>is<span class="w"> </span>available<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>podified<span class="w"> </span>cinder<span class="w"> </span>services<span class="w"> </span>using<span class="w"> </span><span class="s2">&quot;extraMounts&quot;</span><span class="w"> </span>or<span class="w"> </span>remove<span class="w"> </span>the<span class="w"> </span>option.

WARNING:root:Deployment<span class="w"> </span>uses<span class="w"> </span>Ceph,<span class="w"> </span>so<span class="w"> </span>make<span class="w"> </span>sure<span class="w"> </span>the<span class="w"> </span>Ceph<span class="w"> </span>credentials<span class="w"> </span>and<span class="w"> </span>configuration<span class="w"> </span>are<span class="w"> </span>present<span class="w"> </span><span class="k">in</span><span class="w"> </span>OpenShift<span class="w"> </span>as<span class="w"> </span>a<span class="w"> </span>asecret<span class="w"> </span>and<span class="w"> </span><span class="k">then</span><span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span>extra<span class="w"> </span>volumes<span class="w"> </span>to<span class="w"> </span>make<span class="w"> </span>them<span class="w"> </span>available<span class="w"> </span><span class="k">in</span><span class="w"> </span>all<span class="w"> </span>the<span class="w"> </span>services<span class="w"> </span>that<span class="w"> </span>would<span class="w"> </span>need<span class="w"> </span>them.

WARNING:root:You<span class="w"> </span>were<span class="w"> </span>using<span class="w"> </span>user<span class="w"> </span><span class="o">[</span><span class="s1">&#39;nova&#39;</span><span class="o">]</span><span class="w"> </span>to<span class="w"> </span>talk<span class="w"> </span>to<span class="w"> </span>Nova,<span class="w"> </span>but<span class="w"> </span><span class="k">in</span><span class="w"> </span>podified<span class="w"> </span>we<span class="w"> </span>prefer<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span>service<span class="w"> </span>keystone<span class="w"> </span>username,<span class="w"> </span><span class="k">in</span><span class="w"> </span>this<span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;cinder&#39;</span><span class="o">]</span>.<span class="w"> </span>Dropping<span class="w"> </span>that<span class="w"> </span>configuration.

WARNING:root:ALWAYS<span class="w"> </span>REVIEW<span class="w"> </span>RESULTS,<span class="w"> </span>OUTPUT<span class="w"> </span>IS<span class="w"> </span>JUST<span class="w"> </span>A<span class="w"> </span>ROUGH<span class="w"> </span>DRAFT!!

Output<span class="w"> </span>written<span class="w"> </span>at<span class="w"> </span>./:<span class="w"> </span>cinder.patch
</code></pre></div>
<p>The script outputs some warnings to let us know things we may need to do
manually -adding the custom policy, provide the ceph configuration files- and
also let us know a change in how the <code>service_user</code> has been removed.</p>
<p>A different example when using multiple backends, one of them being a 3PAR FC
could be:</p>
<div class="highlight"><pre><span></span><code>$ python cinder-cfg.py --config cinder.conf --out-dir ./
WARNING:root:Cinder is configured to use [&#39;/etc/cinder/policy.yaml&#39;] as policy file, please ensure this file is available for the podified cinder services using &quot;extraMounts&quot; or remove the option.

ERROR:root:Backend hpe_fc requires a vendor container image, but there is no certified image available yet. Patch will use the last known image for reference, but IT WILL NOT WORK

WARNING:root:Deployment uses Ceph, so make sure the Ceph credentials and configuration are present in OpenShift as a asecret and then use the extra volumes to make them available in all the services that would need them.

WARNING:root:You were using user [&#39;nova&#39;] to talk to Nova, but in podified we prefer using the service keystone username, in this case [&#39;cinder&#39;]. Dropping that configuration.

WARNING:root:Configuration is using FC, please ensure all your OpenShift nodes have HBAs or use labels to ensure that Volume and Backup services are scheduled on nodes with HBAs.

WARNING:root:ALWAYS REVIEW RESULTS, OUTPUT IS JUST A ROUGH DRAFT!!

Output written at ./: cinder.patch, cinder-prereq.yaml
</code></pre></div>
<p>In this case we can see that there are additional messages, so let's quickly go over them:</p>
<ul>
<li>There's one message mentioning how this backend driver needs external vendor
dependencies so the standard container image will not work. Unfortunately this
image is still not available, so an older image is used in the output patch file
for reference. We can then replace this image with one we build ourselves or
with a Red Hat official one once the image is available. In this case we can see
in our <code>cinder.patch</code> file:
  <div class="highlight"><pre><span></span><code>      cinderVolumes:
      hpe-fc:
        containerImage: registry.connect.redhat.com/hpe3parcinder/openstack-cinder-volume-hpe3parcinder17-0
</code></pre></div></li>
<li>
<p>The FC message reminds us that this transport protocol requires specific HBA
cards to be present on the nodes where cinder services are running.</p>
</li>
<li>
<p>In this case we also see that it has created the <code>cinder-prereq.yaml</code> file and
if we look into it we'll see there is one <code>MachineConfig</code> and one <code>Secret</code>. The
<code>MachineConfig</code> is called <code>99-master-cinder-enable-multipathd</code> and like the name
suggests enables multipathing on all the OCP worker nodes. The <code>Secret</code> is
called <code>openstackcinder-volumes-hpe_fc</code> and contains the 3PAR backend
configuration because it has sensitive information (credentials), and in the
<code>cinder.patch</code> file we'll see that it uses this configuration:
  <div class="highlight"><pre><span></span><code>   cinderVolumes:
      hpe-fc:
        customServiceConfigSecrets:
        - openstackcinder-volumes-hpe_fc
</code></pre></div></p>
</li>
</ul>
<h2 id="procedure-cinder-adoption">Procedure - Cinder adoption<a class="headerlink" href="#procedure-cinder-adoption" title="Permanent link">#</a></h2>
<p>Assuming we have already stopped cinder services, prepared the OpenShift nodes,
deployed the OpenStack operators and a bare OpenStack manifest, and migrated the
database, and prepared the patch manifest with the Cinder service configuration,
all that's left is to apply the patch and wait for the operator to apply the
changes and deploy the Cinder services.</p>
<p>Our recommendation is to write the patch manifest into a file, for example
<code>cinder.patch</code> and then apply it with something like:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span>patch<span class="w"> </span>openstackcontrolplane<span class="w"> </span>openstack<span class="w"> </span>--type<span class="o">=</span>merge<span class="w"> </span>--patch-file<span class="o">=</span>cinder.patch
</code></pre></div>
<p>For example, for the RBD deployment from the Development Guide the
<code>cinder.patch</code> would look like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">extraMounts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">extraVol</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">extraVolType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ceph</span>
<span class="w">      </span><span class="nt">mounts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/ceph</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
<span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">propagation</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CinderVolume</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CinderBackup</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Glance</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph</span>
<span class="w">        </span><span class="nt">projected</span><span class="p">:</span>
<span class="w">          </span><span class="nt">sources</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ceph-conf-files</span>
<span class="w">  </span><span class="nt">cinder</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">apiOverride</span><span class="p">:</span>
<span class="w">      </span><span class="nt">route</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">    </span><span class="nt">template</span><span class="p">:</span>
<span class="w">      </span><span class="nt">databaseInstance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack</span>
<span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osp-secret</span>
<span class="w">      </span><span class="nt">cinderAPI</span><span class="p">:</span>
<span class="w">        </span><span class="nt">override</span><span class="p">:</span>
<span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<span class="w">            </span><span class="nt">internal</span><span class="p">:</span>
<span class="w">              </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">                </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">                  </span><span class="nt">metallb.universe.tf/address-pool</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">internalapi</span>
<span class="w">                  </span><span class="nt">metallb.universe.tf/allow-shared-ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">internalapi</span>
<span class="w">                  </span><span class="nt">metallb.universe.tf/loadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">172.17.0.80</span>
<span class="w">              </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">[DEFAULT]</span>
<span class="w">          </span><span class="no">default_volume_type=tripleo</span>
<span class="w">      </span><span class="nt">cinderScheduler</span><span class="p">:</span>
<span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">cinderBackup</span><span class="p">:</span>
<span class="w">        </span><span class="nt">networkAttachments</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage</span>
<span class="w">        </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">        </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">[DEFAULT]</span>
<span class="w">          </span><span class="no">backup_driver=cinder.backup.drivers.ceph.CephBackupDriver</span>
<span class="w">          </span><span class="no">backup_ceph_conf=/etc/ceph/ceph.conf</span>
<span class="w">          </span><span class="no">backup_ceph_user=openstack</span>
<span class="w">          </span><span class="no">backup_ceph_pool=backups</span>
<span class="w">      </span><span class="nt">cinderVolumes</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ceph</span><span class="p">:</span>
<span class="w">          </span><span class="nt">networkAttachments</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage</span>
<span class="w">          </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">          </span><span class="nt">customServiceConfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">            </span><span class="no">[tripleo_ceph]</span>
<span class="w">            </span><span class="no">backend_host=hostgroup</span>
<span class="w">            </span><span class="no">volume_backend_name=tripleo_ceph</span>
<span class="w">            </span><span class="no">volume_driver=cinder.volume.drivers.rbd.RBDDriver</span>
<span class="w">            </span><span class="no">rbd_ceph_conf=/etc/ceph/ceph.conf</span>
<span class="w">            </span><span class="no">rbd_user=openstack</span>
<span class="w">            </span><span class="no">rbd_pool=volumes</span>
<span class="w">            </span><span class="no">rbd_flatten_volume_from_snapshot=False</span>
<span class="w">            </span><span class="no">report_discard_supported=True</span>
</code></pre></div>
<p>Once the services have been deployed we'll need to clean up the old scheduler
and backup services which will appear as being down while we have others that
appear as being up:</p>
<div class="highlight"><pre><span></span><code>openstack<span class="w"> </span>volume<span class="w"> </span>service<span class="w"> </span>list

+------------------+------------------------+------+---------+-------+----------------------------+
<span class="p">|</span><span class="w"> </span>Binary<span class="w">           </span><span class="p">|</span><span class="w"> </span>Host<span class="w">                   </span><span class="p">|</span><span class="w"> </span>Zone<span class="w"> </span><span class="p">|</span><span class="w"> </span>Status<span class="w">  </span><span class="p">|</span><span class="w"> </span>State<span class="w"> </span><span class="p">|</span><span class="w"> </span>Updated<span class="w"> </span>At<span class="w">                 </span><span class="p">|</span>
+------------------+------------------------+------+---------+-------+----------------------------+
<span class="p">|</span><span class="w"> </span>cinder-backup<span class="w">    </span><span class="p">|</span><span class="w"> </span>standalone.localdomain<span class="w"> </span><span class="p">|</span><span class="w"> </span>nova<span class="w"> </span><span class="p">|</span><span class="w"> </span>enabled<span class="w"> </span><span class="p">|</span><span class="w"> </span>down<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">2023</span>-06-28T11:00:59.000000<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>cinder-scheduler<span class="w"> </span><span class="p">|</span><span class="w"> </span>standalone.localdomain<span class="w"> </span><span class="p">|</span><span class="w"> </span>nova<span class="w"> </span><span class="p">|</span><span class="w"> </span>enabled<span class="w"> </span><span class="p">|</span><span class="w"> </span>down<span class="w">  </span><span class="p">|</span><span class="w"> </span><span class="m">2023</span>-06-28T11:00:29.000000<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>cinder-volume<span class="w">    </span><span class="p">|</span><span class="w"> </span>hostgroup@tripleo_ceph<span class="w"> </span><span class="p">|</span><span class="w"> </span>nova<span class="w"> </span><span class="p">|</span><span class="w"> </span>enabled<span class="w"> </span><span class="p">|</span><span class="w"> </span>up<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="m">2023</span>-06-28T17:00:03.000000<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>cinder-scheduler<span class="w"> </span><span class="p">|</span><span class="w"> </span>cinder-scheduler-0<span class="w">     </span><span class="p">|</span><span class="w"> </span>nova<span class="w"> </span><span class="p">|</span><span class="w"> </span>enabled<span class="w"> </span><span class="p">|</span><span class="w"> </span>up<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="m">2023</span>-06-28T17:00:02.000000<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>cinder-backup<span class="w">    </span><span class="p">|</span><span class="w"> </span>cinder-backup-0<span class="w">        </span><span class="p">|</span><span class="w"> </span>nova<span class="w"> </span><span class="p">|</span><span class="w"> </span>enabled<span class="w"> </span><span class="p">|</span><span class="w"> </span>up<span class="w">    </span><span class="p">|</span><span class="w"> </span><span class="m">2023</span>-06-28T17:00:01.000000<span class="w"> </span><span class="p">|</span>
+------------------+------------------------+------+---------+-------+----------------------------+
</code></pre></div>
<p>In this case we need to remove services for hosts <code>standalone.localdomain</code></p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>cinder-scheduler-0<span class="w"> </span>--<span class="w"> </span>cinder-manage<span class="w"> </span>service<span class="w"> </span>remove<span class="w"> </span>cinder-backup<span class="w"> </span>standalone.localdomain
oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>cinder-scheduler-0<span class="w"> </span>--<span class="w"> </span>cinder-manage<span class="w"> </span>service<span class="w"> </span>remove<span class="w"> </span>cinder-scheduler<span class="w"> </span>standalone.localdomain
</code></pre></div>
<p>The reason why we haven't preserved the name of the backup service is because
we have taken the opportunity to change its configuration to support
Active-Active, even though we are not doing so right now because we have 1
replica.</p>
<p>Now that we have the Cinder services running we know that the DB schema
migration has been completed and we can proceed to apply the DB data migrations.
While it is not necessary to run these data migrations at this precise moment,
because we can just run them right before the next upgrade, we consider that for
adoption it's best to run them now to make sure there are no issues before
running production workloads on the deployment.</p>
<p>The command to run the DB data migrations is:</p>
<div class="highlight"><pre><span></span><code>oc<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>cinder-scheduler-0<span class="w"> </span>--<span class="w"> </span>cinder-manage<span class="w"> </span>db<span class="w"> </span>online_data_migrations
</code></pre></div>
<h2 id="post-checks">Post-checks<a class="headerlink" href="#post-checks" title="Permanent link">#</a></h2>
<p>Before we can run any checks we need to set the right cloud configuration for
the <code>openstack</code> command to be able to connect to our OpenShift control plane.</p>
<p>Just like we did in the KeyStone adoption step we ensure we have the <code>openstack</code> alias defined:</p>
<div class="highlight"><pre><span></span><code><span class="nb">alias</span><span class="w"> </span><span class="nv">openstack</span><span class="o">=</span><span class="s2">&quot;oc exec -t openstackclient -- openstack&quot;</span>
</code></pre></div>
<p>Now we can run a set of tests to confirm that the deployment is there using our
old database contents:</p>
<ul>
<li>See that Cinder endpoints are defined and pointing to the podified
  FQDNs:</li>
</ul>
<div class="highlight"><pre><span></span><code>openstack endpoint list --service cinderv3
</code></pre></div>
<ul>
<li>Check that the cinder services are running and up. The API won't show but if
  you get a response you know it's up as well:</li>
</ul>
<div class="highlight"><pre><span></span><code>openstack volume service list
</code></pre></div>
<ul>
<li>Check that our old volume types, volumes, snapshots, and backups are there:</li>
</ul>
<div class="highlight"><pre><span></span><code>openstack volume type list
openstack volume list
openstack volume snapshot list
openstack volume backup list
</code></pre></div>
<p>To confirm that everything not only looks good but it's also properly working
we recommend doing some basic operations:</p>
<ul>
<li>
<p>Create a volume from an image to check that the connection to glance is
  working.
  <div class="highlight"><pre><span></span><code>openstack<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>--image<span class="w"> </span>cirros<span class="w"> </span>--bootable<span class="w"> </span>--size<span class="w"> </span><span class="m">1</span><span class="w"> </span>disk_new
</code></pre></div></p>
</li>
<li>
<p>Backup the old attached volume to a new backup. Example:
  <div class="highlight"><pre><span></span><code>openstack<span class="w"> </span>--os-volume-api-version<span class="w"> </span><span class="m">3</span>.47<span class="w"> </span>volume<span class="w"> </span>create<span class="w"> </span>--backup<span class="w"> </span>backup<span class="w"> </span>restored
</code></pre></div></p>
</li>
</ul>
<p>We don't boot a nova instance using the new volume from image or try to detach
the old volume because nova and cinder are still not connected.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      2023-10-04
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
    
  </body>
</html>